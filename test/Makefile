TARGET = snake # General Makefile variable: the name of the executable to be made
COBJECTS = main.o # The names of any objects to be made from *.c files
ICOBJECTS = # Should be blank: `icp` will add the object files needed
ICCLEANS = # Should be blank: `icp` will add the clean rule names needed
ICMAKES = snake.mk # The names of the makefiles that `icp` will make

.SECONDEXPANSION: # Necessary to handle `$($*.c)` in the prereqs

all: $(TARGET) # Ensures that `make` will make the TARGET by default


include $(ICMAKES) # Use all of the makefiles that `icp` will make, too


$(TARGET): $(COBJECTS) $(ICOBJECTS) # TARGET has prereqs COBJECTS and ICOBJECTS
	# Link (with defaults) the prereqs into the target
	$(CC) -o $@ $(LDFLAGS) $^ $(LOADLIBES) $(LDLIBS)

$(COBJECTS): $($*.c) *.h # COBJECTS have their .c file and all headers as prereqs
	$(CC) -c $(CFLAGS) $*.c # Compile the COBJECTS from <stem>.c files

%.mk: %.ic *.h # <stem>.mk has <stem>.ic and all headers as prereqs
	../icp $< # Runs `icp` on the .ic file, making the corresponding .mk file
	          # Also makes the necessary C files

clean: $(ICCLEANS) # Has all clean rules generated by `icp` as prereqs
	# Removes everything generated in this file
	-rm -f $(TARGET) $(COBJECTS) $(ICOBJECTS) $(ICMAKES)


